#!/bin/env -S deno run -A
// Note `env -S` may not be portable, https://unix.stackexchange.com/a/477651

import { unified } from "npm:unified";
import remarkParse from "npm:remark-parse";
import remarkGfm from "npm:remark-gfm";
import remarkStringify from "npm:remark-stringify";
import { Command, string } from "https://deno.land/x/clay@v0.2.5/mod.ts";

const main = async () => {
  const cmd = new Command("francium's custom markdown formatter")
    .required(string, "file");

  const args =  cmd.run();

  const inputText = Deno.readTextFileSync(args.file);
  const formattedFile = await unified()
    .use(remarkParse)
    .use(remarkGfm)
    .use(remarkStringify, {
      bullet: "-",
      emphasis: "_",
      fences: true,
      listItemIndent: "one",
      join: [
        (left, right) => {
          if (left.type === "heading" && right.type === "heading") {
            return 2;
          }
          if (right.type === "heading") {
            return 2;
          }

          return undefined;
        },
      ],
    })
    .process(inputText);
  Deno.writeTextFileSync(args.file, formattedFile.toString());
};

if (import.meta.main) {
  main();
}
